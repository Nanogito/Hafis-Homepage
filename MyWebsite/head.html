<script type="text/javascript">
//<![CDATA[
/* Inhalt dieser Datei gehört in MyWebsite unter
     Einstellungen | Erw. Einstellungen bearbeiten | Head bearbeiten
   Speichern nicht vergessen ;)
*/
(function ($) {
	var options = {
		videoPlaceholderTitle: "Youtube-Video laden\n(zum Abspielen nochmal klicken)",
		reportUnsafeVideos: true,
		
		// In navi buttons: replace any (A|a)e, (O|o)e, (U|u)e by &Auml; etc...
		// Because: we must not use actual umlauts (Ä, ä, Ö, ö, Ü, ü) for page 
		// names in MyWebsite, since they result in garbled pathnames.
		// So we use ae, oe, ue instead. But we do want to show properly rendered
		// umlauts to the user. That's what this this little hack is about.
		umlaut: {
			// pop-up about any left over actual Ä, ä, Ö, ö, Ü, ü in page names
			reportProblematicNames: true,
			// don't replace in these words:
			// (Note: will be used in regular expression - normal letters only!)
			except: ["Aktuell"],
		},
		videos: {
			// pop-up about videos embedded in non-"privacy enhanced mode"
			// (as does the MyWebsite widget "Video einfügen")
			reportUnsafeVideos: true,
			// *when* to replace a placeholder with the actual <iframe>:
			// - true: only when user clicks on it (and then only this placeholder)
			// - false: replace all placeholders right before page is shown
			embedOnlyWhenClicked: true,
			// appears as tooltip when user hovers over a placeholder image
			placeholderTitle: "Youtube-Video laden"
				+"\n(zum Abspielen nochmal klicken)",
		}
	};
	
	function searchParams(url) {
		try { // don't crash on old IE, but rather return empty object
			return (url.search || "?")
				.substring(1)
				.split("&")
				.reduce(function (acc, s) {
					var pieces = s.split("=");
					var k = pieces[0];
					var v = pieces[1];
					var i = parseInt(v);
					if (isFinite(i)) {
						v = i;
					}
					acc[k] = v;
					return acc;
				}, {});
		} catch (e) {
			return {};
		}
	}
	
	var params = searchParams(window.location);
	var isDebug = Object.prototype.hasOwnProperty.call(params, "debug")
		&& ((params.debug === void(0)) || !!params.debug);
	
	var log = function () {
		isDebug && console.log.apply(console, $.makeArray(arguments));
	};
	log("options", options);
	
	function germanUmlaut() { /* Umlaute-Hack */
		var btns = $('body #mainNav1 span');
		log("germanUmlaut/page names found:", btns.map(function (i, e) {
			return $(e).html();
		}));
		var ex = new RegExp(options.umlaut.except.join("|"), "im");
		btns.each(function (i, e) {
			e = $(e);
			var oldH = e.html();
			if (ex.exec(oldH)) {
				log("germanUmlaut/omitted:", oldH);
			} else {
				var newH = oldH.replace(/([aouAOU])e/g, "&$1uml;");
				if (oldH != newH) {
					e.html(newH);
					log("germanUmlaut/replaced:", oldH, "->", newH);
				}
			}
		});
	}
	// germanUmlaut(); // <<<<<<<<<<<<<<<<<<<<<<< debug
	function embedVideos() {
		var xs = $("body a[href*=youtube],[href*=youtu\\.be]").has("> img");
		if (options.videoPlaceholderTitle) {
			xs.each(function (idx, elem) {
				$(elem).attr("title", options.videoPlaceholderTitle);
			});
		}
		log("embedVideos:", xs);
		xs.on("click", function (evt) {
			var elem = evt.currentTarget;
			var vID = (elem.host == "youtu.be")
				? elem.pathname.substring(1)
				: searchParams(elem).v;
			log("click", evt);
			elem = $(elem);
			var img = elem.find("img")[0];
			var w = img.width;
			var h = img.height;
			var iframe = $("<iframe>", {
				src: "https://www.youtube-nocookie.com/embed/" + vID + "?rel=0",
				frameborder: 0,
				allow: "autoplay; encrypted-media",
				allowfullscreen: "",
				width: w,
				height: h
			});
			log("embedVideos:", iframe);
			elem.replaceWith(iframe);
			return false;
		});
		return xs;
	}
	
	function reportUnsafeVideos() {
		var xs = $("body iframe[src*=youtube\\.com]");
		var n = xs.length;
		if (n) {
			var msg = "ACHTUNG: " + n + " Video" + (n > 1 ? "s" : "")
				+ " wurde" + (n > 1 ? "n" : "")
				+ " NICHT datenschutzkonform eingebunden!\n\n"
				+ "Bitte jeweils durch ein verlinktes Platzhalterbild ersetzen.\n"
			;
			xs.each(function (i, e) {
				msg += "\n" + $(e).attr("src");
			});
			alert(msg);
		}
	}

	$(document).ready(germanUmlaut);
	$(document).ready(reportUnsafeVideos);
	$(document).ready(embedVideos);
	
}(jQuery));
//]]>
</script>
