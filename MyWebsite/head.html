<script type="text/javascript">
//<![CDATA[
/* Inhalt dieser Datei gehört in MyWebsite unter
     Einstellungen | Erw. Einstellungen bearbeiten | Head bearbeiten
   Speichern nicht vergessen ;)
*/
(function ($) {
	var options = {
		// In navi buttons: replace any (A|a)e, (O|o)e, (U|u)e by &Auml; etc...
		// Because: we must not use actual umlauts (Ä, ä, Ö, ö, Ü, ü) for page 
		// names in MyWebsite, since they result in garbled pathnames.
		// So we use ae, oe, ue instead. But we do want to show properly rendered
		// umlauts to the user.
		// ATTENTION: we do NOT replace ß bei &szlig; since double-s is too common
		//            we do however warn about ß if reportProblematicNames is true
		umlaut: {
			// pop-up about any left over actual Ä, ä, Ö, ö, Ü, ü and ß in page names
			// Note: this is overridden by loading the page with ?debug
			reportProblematicNames: true,
			// don't replace in these words:
			// (Note: will be used in regular expression - normal letters only!)
			except: ["Aktuell"],
		},
		videos: {
			// pop-up about videos embedded in non-"privacy enhanced mode"
			// (as does the MyWebsite widget "Video einfügen")
			// Note: this is overridden by loading the page with ?debug
			reportUnsafeVideos: true, // 
			// *when* to replace a placeholder with the actual <iframe>:
			// - true: only when user clicks on it (and then only this placeholder)
			// - false: replace all placeholders right before page is shown
			embedOnlyWhenClicked: true,
			// appears as tooltip when user hovers over a placeholder image
			placeholderTitle: "Youtube-Video laden"
				+"\n(zum Abspielen nochmal klicken)",
		}
	};
	
	function searchParams(url) {
		try { // don't crash on old IE, but rather return empty object
			return (url.search || "?")
				.substring(1)
				.split("&")
				.reduce(function (acc, s) {
					var pieces = s.split("=");
					var k = pieces[0];
					var v = pieces[1];
					var i = parseInt(v);
					if (isFinite(i)) {
						v = i;
					}
					acc[k] = v;
					return acc;
				}, {});
		} catch (e) {
			return {};
		}
	}
	
	var params = searchParams(window.location);
	var isDebug = Object.prototype.hasOwnProperty.call(params, "debug")
		&& ((params.debug === void(0)) || !!params.debug);
	
	var log = function () {
		isDebug && console.log.apply(console, $.makeArray(arguments));
	};
	log("options", options);
	
	function isEditorMode() {
		return !!$("#diyToolbar").length;
	}
	
	function naviButtons() {
		return $('body #mainNav1 span');
	}
	
	function germanUmlaut() { /* Umlaute-Hack */
		var btns = naviButtons();
		log("germanUmlaut/page names found:",
			btns.map(function (i, e) { return $(e).html(); })
		);
		var ex = new RegExp(options.umlaut.except.join("|"), "im");
		btns.each(function (i, e) {
			e = $(e);
			var oldH = e.html();
			if (ex.exec(oldH)) {
				log("germanUmlaut/omitted:", oldH);
			} else { // we do NOT replace ss, since it's too common
				var newH = oldH.replace(/([aouAOU])e/g, "&$1uml;");
				if (oldH != newH) {
					e.html(newH);
					log("germanUmlaut/replaced:", oldH, "->", newH);
				}
			}
		});
	}
	
	function reportProblematicPageNames() {
		if (!(isDebug || (isEditorMode() && options.umlaut.reportProblematicNames)))
			return;

		var rx = /[äöüß]/ig; // warn about ß as well!
		var bad = naviButtons().parent().filter(function (i, e) {
			rx.lastIndex = 0; // reset!
			return rx.test(
				decodeURI(e.pathname) // yes, even %C3%B6 and the like
			);                        // pose problems!
		});
		log(bad);
		var n = bad.length;
		if (n) {
			var msg = "ACHTUNG: " + n + " Seitenname" + (n > 1 ? "n" : "")
				+ " ent" + (n > 1 ? "halten" : "hält")
				+ " problematische Zeichen!\n\n"
				+ "Bitte durch Ae, ae, Oe, oe, Ue, ue oder ss ersetzen.\n"
			;
			bad.each(function (i, e) {
				var name = $(e).find("span").html();
				var path = decodeURI(e.pathname);
				var culprits = path.match(rx);
				msg += '\n"' + name + '": ' + culprits.join(", ")
					+ ' in ' + path
				;
			});
			alert(msg);
		}
	}
	
	
	function embedVideos() {
		var xs = $("body a[href*=youtube],[href*=youtu\\.be]").has("> img");
		var t = options.videos.placeholderTitle;
		if (t)
			xs.each(function (i, e) { $(e).attr("title", t); });
		log("embedVideos:", xs);
		xs.on("click", function (evt) {
			var elem = evt.currentTarget;
			var vID = (elem.host == "youtu.be")
				? elem.pathname.substring(1)
				: searchParams(elem).v;
			log("click", evt);
			elem = $(elem);
			var img = elem.find("img")[0];
			var w = img.width;
			var h = img.height;
			var iframe = $("<iframe>", {
				src: "https://www.youtube-nocookie.com/embed/" + vID + "?rel=0",
				frameborder: 0,
				allow: "autoplay; encrypted-media",
				allowfullscreen: "",
				width: w,
				height: h
			});
			log("embedVideos:", iframe);
			elem.replaceWith(iframe);
			return false;
		});
		return xs;
	}
	
	function reportUnsafeVideos() {
		if (!(isDebug || (isEditorMode() && options.videos.reportUnsafeVideos)))
			return;

		var bad = $("body iframe[src*=youtube\\.com]");
		var n = bad.length;
		if (n) {
			var msg = "ACHTUNG: " + n + " Video" + (n > 1 ? "s" : "")
				+ " wurde" + (n > 1 ? "n" : "")
				+ " NICHT datenschutzkonform eingebunden!\n\n"
				+ "Bitte jeweils durch ein verlinktes Platzhalterbild ersetzen.\n"
			;
			bad.each(function (i, e) {
				msg += "\n" + $(e).attr("src");
			});
			alert(msg);
		}
	}
	
	// the fix-ups
	$(document).ready(germanUmlaut);
	$(document).ready(embedVideos);
	
	// the warnings:
	// options will be checked within the functions, because
	// we need to know wether we're in editor mode or not.
	// in order to know (for sure) whether we're in editor mode,
	// we have to wait a little bit
	$(document).ready(function ($) {
		setTimeout(reportProblematicPageNames, 1000);
		setTimeout(reportUnsafeVideos, 1500);
	});
	
	
	// vvvvvvvvvvvv DEBUG! vvvvvvvvvvvvv
	__ = {
		options: options,
		isDebug: function () {
			if (arguments.length)
				isDebug = arguments[0];
			return isDebug;
		},
		isEditorMode: isEditorMode,

		germanUmlaut: germanUmlaut, 
		reportProblematicPageNames: reportProblematicPageNames,
		reportUnsafeVideos: reportUnsafeVideos,
		embedVideos: embedVideos
	};
}(jQuery));
//]]>
</script>